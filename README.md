# BRT-сервис (Billing Real-Time Service)

## Описание

BRT-сервис (Billing Real-Time Service) — это компонент телекоммуникационной биллинговой системы, отвечающий за обработку данных о вызовах в режиме реального времени и их тарификацию.

## Назначение

BRT-сервис выполняет следующие функции:
- Получение записей CDR  от CDR-сервиса через RabbitMQ
- Обработка и фильтрация CDR-записей
- Передача данных о тарификации вызовов в HRS-сервис
- Сохранение CDR-записей в базе данных 
- Получение счетов по результатам тарификации через RabbitMQ
- Обработка платежей и управление балансом абонентов

## Процесс обработки вызовов

### Получение CDR из RabbitMQ

1. Метод `consumeCdr()` в `CdrConsumerService` получает пакет CDR через RabbitMQ (канал `${const.rabbitmq.cdr.CDR_QUEUE_NAME}`)
2. Полученные записи передаются для дальнейшей обработки в метод `processOurSubscribersCdr()`

### Фильтрация CDR

Для каждой полученной записи о вызове:

1. Проверяется, является ли обслуживаемый абонент клиентом нашей компании (метод `isOur()`)
2. Если абонент не является нашим, запись игнорируется
3. Если абонент является нашим, CDR конвертируется в формат `CallWithDefaultMetadataDTO`

### Преобразование CDR в формат для тарификации

Метод `convertToCallWithDefaultMetadataDTO()` в `CdrService`:

1. Получает информацию об абоненте из базы данных
2. Определяет, является ли второй участник звонка нашим абонентом
3. Рассчитывает длительность звонка в минутах
4. Формирует объект с метаданными о вызове, включающий:
   - Идентификатор вызова
   - Тип вызова (входящий/исходящий)
   - Номер обслуживаемого абонента
   - Номер другого абонента
   - Время начала и окончания вызова
   - Длительность вызова в минутах
   - Информацию об операторе другого абонента

### Отправка данных на тарификацию

Данные о вызове отправляются в очередь RabbitMQ для дальнейшей тарификации:

1. Сформированный объект `CallWithDefaultMetadataDTO` отправляется через RabbitTemplate
2. Используется обмен `${const.rabbitmq.tariffication.TARIFFICATION_EXCHANGE_NAME}`
3. С ключом маршрутизации `${const.rabbitmq.tariffication.CALL_USAGE_ROUTING_KEY}`
4. Отправленная запись CDR сохраняется в базе данных BRT-сервиса

## Взаимодействие с HRS-сервисом

BRT-сервис взаимодействует с HRS-сервисом для тарификации вызовов:

### Класс HRSServiceClient

1. Метод `chargeCdr()` отправляет данные о вызове в HRS для расчета стоимости
2. Метод `setTariffForSubscriber()` позволяет назначить тариф абоненту
3. Метод `getSystemDatetime()` получает системное время от HRS-сервиса

## Процесс обработки счетов

### Получение счетов из RabbitMQ

Сервис получает данные о тарификации через соответствующую очередь RabbitMQ:

1. Конфигурация обмена сообщениями для счетов настроена с использованием:
   - `const.rabbitmq.bills.BILLS_QUEUE_NAME`: имя очереди для получения счетов
   - `const.rabbitmq.bills.BILLS_EXCHANGE_NAME`: имя обмена для счетов
   - `const.rabbitmq.bills.BILLS_ROUTING_KEY`: ключ маршрутизации для счетов

2. После того как HRS-сервис обрабатывает звонок и формирует счет, соответствующий счет отправляется в BRT-сервис

### Обработка платежей

BRT-сервис обеспечивает обработку платежей абонентов:

1. Списание средств с баланса абонента при получении счетов от HRS-сервиса

## Структура данных

### Сохраняемые данные о CDR

- Идентификатор записи
- Тип вызова (входящий/исходящий)
- Номер обслуживаемого абонента
- Номер другого абонента
- Дата и время начала вызова
- Дата и время окончания вызова

### Данные для тарификации (CallWithDefaultMetadataDTO)

- Идентификатор абонента
- Метаданные вызова (DefaultCallMetadata)
  - Идентификатор вызова
  - Тип вызова
  - Номера абонентов
  - Временные метки
  - Длительность
  - Информация об операторе второго абонента

### Данные о платежах

- Идентификатор абонента
- Сумма платежа
- Единицы измерения

## Технические детали

### Конфигурационные параметры

- `const.hrs-service.BASE_URL`: базовый URL для взаимодействия с HRS-сервисом
- `const.rabbitmq.cdr.CDR_QUEUE_NAME`: имя очереди для получения CDR
- `const.rabbitmq.tariffication.CALL_USAGE_ROUTING_KEY`: ключ маршрутизации для тарификации
- `const.rabbitmq.tariffication.TARIFFICATION_EXCHANGE_NAME`: имя обмена для тарификации
- `const.rabbitmq.bills.BILLS_QUEUE_NAME`: имя очереди для получения счетов
- `const.rabbitmq.bills.BILLS_EXCHANGE_NAME`: имя обмена для счетов
- `const.rabbitmq.bills.BILLS_ROUTING_KEY`: ключ маршрутизации для счетов

### Используемые технологии

- Фреймворк: Spring Boot
- БД: PostgreSQL
- Очередь сообщений: RabbitMQ
- Сервисная регистрация: Eureka
- Конфигурация: Spring Cloud Config
- REST-клиент: Spring RestClient
